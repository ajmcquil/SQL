--Andrew McQuillen
--Assignment 10
--December 7, 2015
--CIS 310-75
--Part 1

DROP TABLE SALEFACT
DROP TABLE STAGING
DROP TABLE CUSTOMERDIM
DROP TABLE DEPARTMENTDIM
DROP TABLE PRODUCTDIM
DROP TABLE EMPLOYEEDIM
DROP TABLE TIMEDIM

CREATE TABLE CUSTOMERDIM (
		CUSTOMER_DIM_ID INT IDENTITY NOT NULL,
		CUST_CODE INT NOT NULL,
		CUST_FNAME NVARCHAR (20) NOT NULL,
		CUST_LNAME NVARCHAR (20) NOT NULL,
		CUST_STREET NVARCHAR (70),
		CUST_CITY NVARCHAR (50),
		CUST_STATE NVARCHAR (2),
		ZIP NVARCHAR (5),
		CUST_BALANCE MONEY)
ALTER TABLE CUSTOMERDIM
	ADD CONSTRAINT PK_CUSTOMERDIM PRIMARY KEY (CUSTOMER_DIM_ID)
ALTER TABLE CUSTOMERDIM
	ADD CONSTRAINT FK_CUST_CODE FOREIGN KEY (CUST_CODE) REFERENCES LGCUSTOMER

CREATE TABLE DEPARTMENTDIM (
		DEPT_DIM_ID INT IDENTITY NOT NULL,
		DEPT_NUM INT NOT NULL,
		DEPT_NAME NVARCHAR (50),
		DEPT_MAIL_BOX NVARCHAR (3),
		DEPT_PHONE NVARCHAR (9),
		EMP_NUM INT NOT NULL)
ALTER TABLE DEPARTMENTDIM
	ADD CONSTRAINT PK_DEPARTMENTDIM PRIMARY KEY (DEPT_DIM_ID)
ALTER TABLE DEPARTMENTDIM
	ADD CONSTRAINT FK_DEPT_NUM FOREIGN KEY (DEPT_NUM) REFERENCES LGDEPARTMENT
ALTER TABLE DEPARTMENTDIM
	ADD CONSTRAINT FK_EMP_NUM FOREIGN KEY (EMP_NUM) REFERENCES LGEMPLOYEE

CREATE TABLE PRODUCTDIM (
		PROD_DIM_ID INT IDENTITY NOT NULL,
		PROD_SKU NVARCHAR (15) NOT NULL,
		PROD_DESCRIPT NVARCHAR (255),
		PROD_TYPE NVARCHAR (255),
		PROD_BASE NVARCHAR (255),
		PROD_CATEGORY NVARCHAR (255),
		PROD_PRICE DECIMAL (10,2),
		PROD_QOH DECIMAL (10,0),
		PROD_MIN DECIMAL (10,0),
		BRAND_ID INT
		)	
ALTER TABLE PRODUCTDIM
	ADD CONSTRAINT PK_PRODUCTDIM PRIMARY KEY (PROD_DIM_ID)
ALTER TABLE PRODUCTDIM
	ADD CONSTRAINT FK_PROD_SKU FOREIGN KEY (PROD_SKU) REFERENCES LGPRODUCT

CREATE TABLE EMPLOYEEDIM (
		EMP_DIM_ID INT IDENTITY NOT NULL,
		EMP_NUM INT NOT NULL,
		EMP_FNAME NVARCHAR (20),
		EMP_LNAME NVARCHAR (25),
		EMP_EMAIL NVARCHAR (25),
		EMP_PHONE NVARCHAR (20),
		EMP_HIREDATE DATETIME,
		EMP_TITLE NVARCHAR (45),
		EMP_COMM DECIMAL (2,2),
		DEPT_NUM INT)
ALTER TABLE EMPLOYEEDIM
	ADD CONSTRAINT PK_EMPLOYEEDIM PRIMARY KEY (EMP_DIM_ID)
ALTER TABLE EMPLOYEEDIM
	ADD CONSTRAINT FK_EMP_ID FOREIGN KEY (EMP_NUM) REFERENCES LGEMPLOYEE

CREATE TABLE TIMEDIM (
		TIME_DIM_ID INT IDENTITY NOT NULL,
		INV_DATE DATETIME,
		MONTH INT,
		YEAR INT)
ALTER TABLE TIMEDIM
	ADD CONSTRAINT PK_TIMEDIM PRIMARY KEY (TIME_DIM_ID)

CREATE TABLE SALEFACT (
		SALEFACT_ID INT IDENTITY NOT NULL,
		CUSTOMER_DIM_ID INT NOT NULL, 
		TIME_DIM_ID INT NOT NULL,
		PROD_DIM_ID INT NOT NULL,
		EMP_DIM_ID INT NOT NULL, 
		DEPT_DIM_ID INT NOT NULL,
		LINE_QTY DECIMAL (10),
		LINE_PRICE MONEY)
ALTER TABLE SALEFACT
	ADD CONSTRAINT PK_SALEFACT PRIMARY KEY (SALEFACT_ID)
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_CUSTOMER_DIM_ID FOREIGN KEY (CUSTOMER_DIM_ID) REFERENCES CUSTOMERDIM
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_TIME_DIM_ID FOREIGN KEY (TIME_DIM_ID) REFERENCES TIMEDIM
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_PRODUCT_DIM_ID FOREIGN KEY (PROD_DIM_ID) REFERENCES PRODUCTDIM
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_DEPARTMENT_DIM_ID FOREIGN KEY (DEPT_DIM_ID) REFERENCES DEPARTMENTDIM

CREATE TABLE STAGING (
		CUST_ID INT,
		TIME_ID INT,
		PROD_ID NVARCHAR (15),
		DEPT_ID INT,
		EMP_ID INT,
		EMP_NUM INT, 
		DEPT_NUM INT,
		LINE_QTY FLOAT,
		LINE_PRICE MONEY,
		CUST_CODE INT,
		PROD_SKU NVARCHAR (15),
		INV_DATE DATETIME)

--Andrew McQuillen
--Assignment 10 Part 2
--December 7, 2015
--CIS 310-75

--CREATE A10 PROCEDURE
ALTER PROCEDURE [A10]
AS 
BEGIN
--DROP THE PRIMARY AND FOREIGN KEYS FROM THE TABLES
ALTER TABLE SALEFACT
	DROP CONSTRAINT PK_SALEFACT
ALTER TABLE SALEFACT
	DROP CONSTRAINT FK_CUSTOMER_DIM_ID
ALTER TABLE SALEFACT
	DROP CONSTRAINT FK_TIME_DIM_ID
ALTER TABLE SALEFACT
	DROP CONSTRAINT FK_PRODUCT_DIM_ID
ALTER TABLE SALEFACT
	DROP CONSTRAINT FK_DEPARTMENT_DIM_ID
ALTER TABLE CUSTOMERDIM
	DROP CONSTRAINT PK_CUSTOMERDIM
ALTER TABLE CUSTOMERDIM
	DROP CONSTRAINT FK_CUST_CODE
ALTER TABLE DEPARTMENTDIM
	DROP CONSTRAINT PK_DEPARTMENTDIM
ALTER TABLE DEPARTMENTDIM
	DROP CONSTRAINT FK_DEPT_NUM
ALTER TABLE DEPARTMENTDIM
	DROP CONSTRAINT FK_EMP_NUM
ALTER TABLE PRODUCTDIM
	DROP CONSTRAINT PK_PRODUCTDIM
ALTER TABLE PRODUCTDIM
	DROP CONSTRAINT FK_PROD_SKU
ALTER TABLE EMPLOYEEDIM
	DROP CONSTRAINT PK_EMPLOYEEDIM
ALTER TABLE EMPLOYEEDIM
	DROP CONSTRAINT FK_EMP_ID
ALTER TABLE TIMEDIM
	DROP CONSTRAINT PK_TIMEDIM
--TRUNCATE THE TABLES
TRUNCATE TABLE CUSTOMERDIM
TRUNCATE TABLE DEPARTMENTDIM
TRUNCATE TABLE PRODUCTDIM
TRUNCATE TABLE EMPLOYEEDIM
TRUNCATE TABLE TIMEDIM
TRUNCATE TABLE SALEFACT
TRUNCATE TABLE STAGING
--ADD THE CONSTRAINTS BACK 
ALTER TABLE CUSTOMERDIM
	ADD CONSTRAINT PK_CUSTOMERDIM PRIMARY KEY (CUSTOMER_DIM_ID)
ALTER TABLE CUSTOMERDIM
	ADD CONSTRAINT FK_CUST_CODE FOREIGN KEY (CUST_CODE) REFERENCES LGCUSTOMER
ALTER TABLE DEPARTMENTDIM 
	ADD CONSTRAINT PK_DEPARTMENTDIM PRIMARY KEY (DEPT_DIM_ID)
ALTER TABLE DEPARTMENTDIM
	ADD CONSTRAINT FK_DEPT_NUM FOREIGN KEY (DEPT_NUM) REFERENCES LGDEPARTMENT
ALTER TABLE DEPARTMENTDIM
	ADD CONSTRAINT FK_EMP_NUM FOREIGN KEY (EMP_NUM) REFERENCES LGEMPLOYEE
ALTER TABLE PRODUCTDIM
	ADD CONSTRAINT PK_PRODUCTDIM PRIMARY KEY (PROD_DIM_ID)
ALTER TABLE PRODUCTDIM
	ADD CONSTRAINT FK_PROD_SKU FOREIGN KEY (PROD_SKU) REFERENCES LGPRODUCT
ALTER TABLE EMPLOYEEDIM
	ADD CONSTRAINT PK_EMPLOYEEDIM PRIMARY KEY (EMP_DIM_ID)
ALTER TABLE EMPLOYEEDIM
	ADD CONSTRAINT FK_EMP_ID FOREIGN KEY (EMP_NUM) REFERENCES LGEMPLOYEE
ALTER TABLE TIMEDIM
	ADD CONSTRAINT PK_TIMEDIM PRIMARY KEY (TIME_DIM_ID)
ALTER TABLE SALEFACT
	ADD CONSTRAINT PK_SALEFACT PRIMARY KEY (SALEFACT_ID)
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_CUSTOMER_DIM_ID FOREIGN KEY (CUSTOMER_DIM_ID) REFERENCES CUSTOMERDIM
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_TIME_DIM_ID FOREIGN KEY (TIME_DIM_ID) REFERENCES TIMEDIM
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_PRODUCT_DIM_ID FOREIGN KEY (PROD_DIM_ID) REFERENCES PRODUCTDIM
ALTER TABLE SALEFACT
	ADD CONSTRAINT FK_DEPARTMENT_DIM_ID FOREIGN KEY (DEPT_DIM_ID) REFERENCES DEPARTMENTDIM

--INSERT DATA FROM LG DATABASE TO CREATED TABLES
INSERT INTO CUSTOMERDIM 
	SELECT	*
	FROM	LGCUSTOMER

INSERT INTO DEPARTMENTDIM 
	SELECT	*
	FROM	LGDEPARTMENT

INSERT INTO PRODUCTDIM
	SELECT	*
	FROM	LGPRODUCT

INSERT INTO EMPLOYEEDIM 
	SELECT	*
	FROM	LGEMPLOYEE

INSERT INTO TIMEDIM 
	SELECT	INV_DATE, MONTH(INV_DATE), YEAR(INV_DATE)
	FROM	LGINVOICE

INSERT INTO STAGING (EMP_NUM, DEPT_NUM, LINE_QTY, LINE_PRICE, CUST_CODE, PROD_SKU, INV_DATE)
	SELECT	E.EMP_NUM, D.DEPT_NUM, L.LINE_QTY, L.LINE_PRICE, C.CUST_CODE, P.PROD_SKU, I.INV_DATE
	FROM	LGCUSTOMER C
			INNER JOIN LGINVOICE I ON C.CUST_CODE = I.CUST_CODE
			INNER JOIN LGLINE L ON I.INV_NUM = L.INV_NUM
			INNER JOIN LGPRODUCT P ON L.PROD_SKU = P.PROD_SKU
			INNER JOIN LGEMPLOYEE E ON I.EMPLOYEE_ID = E.EMP_NUM
			INNER JOIN LGDEPARTMENT D ON E.DEPT_NUM = D.DEPT_NUM
--UPDATE THE STAGING TABLE WITH THE DIMENSION TABLE PK INFO
UPDATE STAGING
SET	CUST_ID = D.CUSTOMER_DIM_ID
FROM	STAGING S INNER JOIN CUSTOMERDIM D
		ON S.CUST_CODE = D.CUST_CODE

UPDATE STAGING 
SET	TIME_ID = D.TIME_DIM_ID
FROM	STAGING S INNER JOIN TIMEDIM D
		ON S.INV_DATE = D.INV_DATE

UPDATE STAGING
SET	PROD_ID = D.PROD_DIM_ID
FROM	STAGING S INNER JOIN PRODUCTDIM D
		ON S.PROD_SKU = D.PROD_SKU

UPDATE STAGING
SET	EMP_ID = D.EMP_DIM_ID
FROM	STAGING S INNER JOIN EMPLOYEEDIM D
		ON S.EMP_NUM = D.EMP_NUM

UPDATE STAGING
SET	DEPT_ID = D.DEPT_DIM_ID
FROM	STAGING S INNER JOIN DEPARTMENTDIM D
		ON S.DEPT_NUM = D.DEPT_NUM
--INSERT DW KEYS AND FACTS INTO THE SALEFACT TABLE
INSERT INTO SALEFACT (CUSTOMER_DIM_ID, TIME_DIM_ID, PROD_DIM_ID, DEPT_DIM_ID, EMP_DIM_ID, LINE_QTY, LINE_PRICE)
	SELECT	CUST_ID, TIME_ID, PROD_ID, DEPT_ID, EMP_ID, LINE_QTY, LINE_PRICE
	FROM	STAGING

END
--RUN STORED PROCEDURE A10
EXEC [A10]
--TEST STAGING TABLE HAS SAME AMOUNT OF ROWS AS LGLINE
SELECT	*
FROM	STAGING


--PART 4 Q1
SELECT	C.CUST_CITY, P.PROD_CATEGORY, SUM(S.LINE_QTY*S.LINE_PRICE) AS TOTAL
FROM	SALEFACT S
		INNER JOIN CUSTOMERDIM C ON S.CUSTOMER_DIM_ID = C.CUSTOMER_DIM_ID
		INNER JOIN PRODUCTDIM P ON S.PROD_DIM_ID = P.PROD_DIM_ID
GROUP BY C.CUST_CITY, P.PROD_CATEGORY

--PART 4 Q2
SELECT	TOP 3 T.MONTH, SUM(S.LINE_QTY*S.LINE_PRICE) AS TOTAL
FROM	SALEFACT S INNER JOIN TIMEDIM T ON S.TIME_DIM_ID =T.TIME_DIM_ID
GROUP BY	T.MONTH 
ORDER BY	TOTAL DESC

--PART 4 Q3
--SELECT THE CUSTOMER CITY, THE EMPLOYEE FIRST NAME, THE DEPARTMENT NAME, AND THE TOTAL SPENT OF ALL CUSTOMERS 
--WHO PURCHASED AN ITEM THAT IS AN EXTERIOR PRIMER IN JANUARY
SELECT	C.CUST_CITY, E.EMP_FNAME, D.DEPT_NAME, SUM(S.LINE_QTY*S.LINE_PRICE) AS TOTAL
FROM	SALEFACT S 
		INNER JOIN CUSTOMERDIM C ON S.CUSTOMER_DIM_ID = C.CUSTOMER_DIM_ID
		INNER JOIN EMPLOYEEDIM E ON S.EMP_DIM_ID =E.EMP_DIM_ID
		INNER JOIN DEPARTMENTDIM D ON S.DEPT_DIM_ID =D.DEPT_DIM_ID
		INNER JOIN TIMEDIM T ON S.TIME_DIM_ID = T.TIME_DIM_ID
		INNER JOIN PRODUCTDIM P ON S.PROD_DIM_ID = P.PROD_DIM_ID
WHERE	P.PROD_TYPE = 'EXTERIOR' AND
		P.PROD_CATEGORY = 'PRIMER' AND
		T.MONTH = 1
GROUP BY	C.CUST_CITY, E.EMP_FNAME, D.DEPT_NAME








