--Andrew McQuillen
--CIS 310-07
--November 9, 2015
--Assignment 8

USE	CIS310A8
--1
SELECT	A.ITEMID, A.DESCRIPTION, A.LISTPRICE
FROM	MERCHANDISE A
WHERE	A.LISTPRICE > (SELECT AVG(B.LISTPRICE)FROM MERCHANDISE B)

--2
USE CIS31046
CREATE VIEW AVGMERCHCOSTVIEW
AS
SELECT	ITEMID, AVG(COST) AS AVGCOST
FROM	CIS310A8..ORDERITEM 
GROUP BY	ITEMID

CREATE VIEW AVGSALEPRICEVIEW
AS
SELECT	ITEMID, AVG(SALEPRICE) AS AVGSALEPRICE
FROM	CIS310A8..SALEITEM
GROUP BY	ITEMID

SELECT	M.ITEMID, M.DESCRIPTION, A.AVGCOST, B.AVGSALEPRICE
FROM	(AVGMERCHCOSTVIEW A INNER JOIN CIS310A8..MERCHANDISE M ON A.ITEMID = M.ITEMID) 
		INNER JOIN AVGSALEPRICEVIEW B ON M.ITEMID = B.ITEMID
WHERE	B.AVGSALEPRICE > 1.5*A.AVGCOST


--3
CREATE VIEW TOTALSALESVIEW
AS
SELECT	S.EMPLOYEEID, E.LASTNAME, SUM(SI.SALEPRICE) AS [SALEPRICE]
FROM	CIS310A8..SALE S INNER JOIN CIS310A8..SALEITEM SI ON
		S.SALEID = SI.SALEID
		INNER JOIN CIS310A8..EMPLOYEE E
		ON S.EMPLOYEEID = E.EMPLOYEEID
GROUP BY	S.EMPLOYEEID,E.LASTNAME

CREATE VIEW SUMOFTOTALVIEW
AS
SELECT	SUM(TOTALSALESVIEW.SALEPRICE) AS [SUMOFTOTAL]
FROM	TOTALSALESVIEW

SELECT	T.EMPLOYEEID, T.LASTNAME, T.SALEPRICE AS TOTALSALES, ((T.SALEPRICE/(SELECT S.SUMOFTOTAL))*100) AS [PCTSALES]
FROM	TOTALSALESVIEW T, SUMOFTOTALVIEW S
ORDER BY	PCTSALES

--4
use cis31046
CREATE VIEW SUPPLIERSHIPTOTALVIEW
AS
SELECT	S.SUPPLIERID, S.NAME, SUM(MO.SHIPPINGCOST) AS SHIPCOST
FROM	CIS310A8..SUPPLIER S INNER JOIN CIS310A8..MERCHANDISEORDER MO ON
		S.SUPPLIERID = MO.SUPPLIERID
GROUP BY	S.SUPPLIERID, S.NAME

CREATE VIEW MERCHORDERTOTAL
AS
SELECT	MO.SUPPLIERID, OI.ITEMID, OI.QUANTITY*OI.COST AS ITEMCOST
FROM	CIS310A8..MERCHANDISEORDER AS MO INNER JOIN CIS310A8..ORDERITEM AS OI ON
		MO.PONUMBER = OI.PONUMBER
GROUP BY	MO.SUPPLIERID, OI.ITEMID, OI.QUANTITY, OI.COST

CREATE VIEW SUMMERCHORDERTOTAL
AS
SELECT	M.SUPPLIERID, S.NAME, ROUND(SUM(M.ITEMCOST),2) AS SUMITEMCOST
FROM	MERCHORDERTOTAL M INNER JOIN CIS310A8..SUPPLIER S 
		ON S.SUPPLIERID = M.SUPPLIERID
GROUP BY	M.SUPPLIERID, S.NAME

CREATE VIEW INDPCTSHIPVIEW
AS
SELECT	B.SUPPLIERID, B.NAME, ROUND(((A.SHIPCOST/(SELECT B.SUMITEMCOST))*100),2) AS INDPCTSHIPCOST
FROM	SUPPLIERSHIPTOTALVIEW A, SUMMERCHORDERTOTAL B

CREATE VIEW PCTSHIPVIEW
AS
SELECT	A.SUPPLIERID, A.NAME, SUM(A.INDPCTSHIPCOST) AS PCTSHIPCOST
FROM	INDPCTSHIPVIEW A
GROUP BY A.SUPPLIERID, A.NAME

SELECT	A.SUPPLIERID, A.NAME, A.PCTSHIPCOST
FROM	PCTSHIPVIEW A
WHERE	A.PCTSHIPCOST = (SELECT MAX(B.PCTSHIPCOST) FROM PCTSHIPVIEW B) 

--5
CREATE VIEW ANIMALSALEVIEW
AS
SELECT	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, SUM(SA.SALEPRICE) AS SUMANIMAL
FROM	CIS310A8..CUSTOMER C INNER JOIN CIS310A8..SALE S ON
		C.CUSTOMERID = S.CUSTOMERID
		INNER JOIN CIS310A8..SALEANIMAL SA ON
		S.SALEID = SA.SALEID
GROUP BY	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME

CREATE VIEW MERCHSALEVIEW
AS
SELECT	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, SUM(SI.SALEPRICE*SI.QUANTITY) AS SUMMERCH
FROM	CIS310A8..CUSTOMER C INNER JOIN CIS310A8..SALE S ON
		C.CUSTOMERID = S.CUSTOMERID INNER JOIN CIS310A8..SALEITEM SI ON
		S.SALEID = SI.SALEID
GROUP BY	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME

CREATE VIEW SUMVIEW
AS
SELECT	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, (A.SUMANIMAL+B.SUMMERCH) AS GRANDTOTAL
FROM	CIS310A8..CUSTOMER AS C INNER JOIN ANIMALSALEVIEW A ON C.CUSTOMERID = A.CUSTOMERID
		INNER JOIN MERCHSALEVIEW AS B ON C.CUSTOMERID = B.CUSTOMERID
GROUP BY	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, A.SUMANIMAL, B.SUMMERCH

SELECT	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, A.SUMMERCH AS MERCTOTAL, B.SUMANIMAL AS ANIMALTOTAL, D.GRANDTOTAL AS GRANDTOTAL
FROM	CIS310A8..CUSTOMER AS C INNER JOIN MERCHSALEVIEW AS A ON C.CUSTOMERID = A.CUSTOMERID
		INNER JOIN ANIMALSALEVIEW AS B ON C.CUSTOMERID = B.CUSTOMERID
		INNER JOIN SUMVIEW AS D ON C.CUSTOMERID = D.CUSTOMERID
WHERE	D.GRANDTOTAL = (SELECT MAX(GRANDTOTAL) FROM SUMVIEW)

--6
USE CIS310A8
SELECT	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, SUM(OI.COST) AS MAY_TOTAL
FROM	MERCHANDISEORDER MO INNER JOIN (ORDERITEM OI INNER JOIN
		(MERCHANDISE M INNER JOIN (SALEITEM SI INNER JOIN 
		(SALE S INNER JOIN CUSTOMER C ON S.CUSTOMERID = C.CUSTOMERID)
		ON SI.SALEID = S.SALEID)
		ON M.ITEMID = SI.ITEMID)
		ON OI.ITEMID = M.ITEMID)
		ON MO.PONUMBER = OI.PONUMBER
WHERE	MO.ORDERDATE LIKE 'MAY%' AND
		C.CUSTOMERID IN (SELECT C.CUSTOMERID FROM MERCHANDISEORDER MO INNER JOIN 
		(ORDERITEM OI INNER JOIN (MERCHANDISE M INNER JOIN (SALEITEM SI INNER JOIN
		(SALE S INNER JOIN CUSTOMER C ON S.CUSTOMERID = C.CUSTOMERID)
		ON SI.SALEID = S.SALEID)
		ON M.ITEMID = SI.ITEMID)
		ON OI.ITEMID = M.ITEMID)
		ON MO.PONUMBER = OI.PONUMBER
WHERE	MO.ORDERDATE LIKE 'OCT%'
GROUP BY	C.CUSTOMERID
HAVING	(SUM(OI.COST) > 50))
GROUP BY C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME
HAVING (SUM(OI.COST) > 100)

--7 
USE CIS31046
CREATE VIEW DOGFOODSALES
AS
SELECT	M.DESCRIPTION, SI.ITEMID, SUM(SI.QUANTITY) AS PURCHASED
FROM	CIS310A8..MERCHANDISE M INNER JOIN CIS310A8..SALEITEM SI
		ON M.ITEMID = SI.ITEMID 
		INNER JOIN CIS310A8..SALE S 
		ON SI.SALEID = S.SALEID
WHERE	S.SALEDATE BETWEEN '2004-JAN-01' AND '2004-JUL-01'
		AND M.DESCRIPTION = 'DOG FOOD-CAN-PREMIUM'
GROUP BY M.DESCRIPTION, SI.ITEMID

CREATE VIEW DOGFOODORDERS
AS
SELECT	M.DESCRIPTION, OI.ITEMID, SUM(OI.QUANTITY) AS ORDERED
FROM	CIS310A8..MERCHANDISE M INNER JOIN CIS310A8..ORDERITEM OI
		ON M.ITEMID = OI.ITEMID
		INNER JOIN CIS310A8..MERCHANDISEORDER MO
		ON OI.PONUMBER = MO.PONUMBER
WHERE	MO.ORDERDATE BETWEEN '2004-JAN-01' AND '2004-JUL-04'
		AND M.DESCRIPTION = 'DOG FOOD-CAN-PREMIUM'
GROUP BY	M.DESCRIPTION, OI.ITEMID
		
SELECT	M.ITEMID, M.DESCRIPTION, A.PURCHASED, B.ORDERED, SUM(B.ORDERED-A.PURCHASED) AS NETINCREASE
FROM	CIS310A8..MERCHANDISE M INNER JOIN DOGFOODSALES A ON M.ITEMID = A.ITEMID
		INNER JOIN DOGFOODORDERS B ON M.ITEMID = B.ITEMID
GROUP BY	M.ITEMID, M.DESCRIPTION, A.PURCHASED, B.ORDERED

--8
USE CIS310A8
SELECT	DISTINCT M.ITEMID, M.DESCRIPTION, M.LISTPRICE
FROM	MERCHANDISE M INNER JOIN (SALEITEM SI INNER JOIN SALE S
		ON SI.SALEID = S.SALEID)
		ON M.ITEMID = SI.ITEMID
WHERE	M.LISTPRICE > 50 AND
		S.SALEDATE NOT IN
		(SELECT S.SALEDATE
		 FROM	MERCHANDISE M INNER JOIN 
		 (SALEITEM SI INNER JOIN SALE S
		 ON SI.SALEID = S.SALEID)
		 ON M.ITEMID = SI.ITEMID
		 WHERE S.SALEDATE LIKE 'JUL%')
ORDER BY	M.ITEMID
--9
SELECT	M.ITEMID, M.DESCRIPTION, M.QUANTITYONHAND, OI.ITEMID
FROM	MERCHANDISE M FULL OUTER JOIN ORDERITEM OI ON 
		M.ITEMID = OI.ITEMID
		FULL OUTER JOIN MERCHANDISEORDER MO
		ON OI.PONUMBER = MO.PONUMBER
WHERE	M.QUANTITYONHAND > 100 AND
		MO.ORDERDATE NOT IN (SELECT MO.ORDERDATE FROM MERCHANDISE M INNER JOIN 
							 (ORDERITEM OI INNER JOIN MERCHANDISEORDER MO
							  ON OI.PONUMBER = MO.PONUMBER)
							  ON M.ITEMID = OI.ITEMID
							  WHERE MO.ORDERDATE LIKE '2004')
GROUP BY M.ITEMID, M.DESCRIPTION, M.QUANTITYONHAND, OI.ITEMID

--10
USE CIS310A8
SELECT	DISTINCT M.ITEMID, M.DESCRIPTION, M.QUANTITYONHAND
FROM	MERCHANDISE M INNER JOIN (ORDERITEM OI INNER JOIN MERCHANDISEORDER MO
		ON OI.PONUMBER = MO.PONUMBER)
		ON M.ITEMID = OI.ITEMID
WHERE	M.QUANTITYONHAND > 100 AND
		MO.ORDERDATE NOT IN
		(SELECT MO.ORDERDATE
		 FROM	MERCHANDISE M INNER JOIN 
		 (ORDERITEM OI INNER JOIN MERCHANDISEORDER MO
		 ON OI.PONUMBER = MO.PONUMBER)
		 ON M.ITEMID = OI.ITEMID
		 WHERE MO.ORDERDATE LIKE '2004')
ORDER BY	M.ITEMID
--11 NOT DONE
USE CIS31046
CREATE TABLE CATEGORY
(
	CATEGORY VARCHAR(50),
	LOW	VARCHAR(50),
	HIGH VARCHAR(50)
)
ALTER TABLE CATEGORY 
ALTER COLUMN CATEGORY VARCHAR(50) NOT NULL
ALTER TABLE CATEGORY
ADD CONSTRAINT PK_CATEGORY PRIMARY KEY(CATEGORY)

INSERT INTO CATEGORY
(CATEGORY, LOW, HIGH)
VALUES('WEAK', 0, 100)
INSERT INTO CATEGORY
(CATEGORY, LOW, HIGH)
VALUES('GOOD',200,800)
INSERT INTO CATEGORY
(CATEGORY,LOW,HIGH)
VALUES('BEST',800,10000)
USE CIS31046
SELECT	A.CUSTOMERID, A.LASTNAME, A.FIRSTNAME, A.GRANDTOTAL, CATEGORY = ISNULL(B.CATEGORY,A.GRANDTOTAL)
FROM	CATEGORY AS B FULL OUTER JOIN
		(
			SELECT	C.CUSTOMERID, C.LASTNAME, C.FIRSTNAME, A.SUMMERCH AS MERCTOTAL, B.SUMANIMAL AS ANIMALTOTAL, D.GRANDTOTAL AS GRANDTOTAL
			FROM	CIS310A8..CUSTOMER AS C INNER JOIN MERCHSALEVIEW AS A ON C.CUSTOMERID = A.CUSTOMERID
			INNER JOIN ANIMALSALEVIEW AS B ON C.CUSTOMERID = B.CUSTOMERID
			INNER JOIN SUMVIEW AS D ON C.CUSTOMERID = D.CUSTOMERID
		) AS A
		ON B.CATEGORY = A.GRANDTOTAL



--12
USE CIS310A8
SELECT	S.NAME, A.ORDERTYPE
FROM	SUPPLIER S INNER JOIN 
	(					 
	 SELECT	'MERCHANDISE' AS ORDERTYPE, S.SUPPLIERID, MO.ORDERDATE
	 FROM	SUPPLIER S INNER JOIN MERCHANDISEORDER MO
		    ON S.SUPPLIERID = MO.SUPPLIERID
	 WHERE	MO.ORDERDATE LIKE 'JUN%'
	 UNION
	 SELECT	'ANIMAL' AS ORDERTYPE, S.SUPPLIERID, AO.ORDERDATE
	 FROM	SUPPLIER S INNER JOIN ANIMALORDER AO
			ON S.SUPPLIERID = AO.SUPPLIERID
	 WHERE	AO.ORDERDATE LIKE 'JUN%'
	) AS A 
	ON S.SUPPLIERID = A.SUPPLIERID
GROUP BY S.NAME, A.ORDERTYPE
	
--13
USE	CIS31046
UPDATE CATEGORY
SET	HIGH = 400
WHERE	CATEGORY = 'WEAK'

--14
DROP TABLE CATEGORY

--15
ALTER TABLE CATEGORY
DROP COLUMN CATEGORY

--16
SELECT	*
INTO	EMPLOYEECOPY
FROM	CIS310A8..EMPLOYEE

DELETE FROM EMPLOYEECOPY

INSERT
INTO	EMPLOYEECOPY
SELECT	*
FROM	CIS310A8..EMPLOYEE
