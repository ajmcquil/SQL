--A9
--AJ McQuillen

SELECT	*
FROM	LGLINE
ORDER BY INV_NUM, PROD_SKU

SELECT	*
FROM	LGPRODUCT
ORDER BY PROD_SKU

DELETE
FROM	LGLINE
WHERE	INV_NUM = 106 AND
		PROD_SKU = '1504-LVK'

INSERT	INTO LGLINE
VALUES(106, 5, '1504-LVK', 15, 27.99)

UPDATE	LGLINE
SET	LINE_QTY = 63
WHERE	INV_NUM = 106 AND PROD_SKU = '1504-LVK'

CREATE TRIGGER A9
ON LGLINE
AFTER INSERT, DELETE, UPDATE
AS
BEGIN
	DECLARE @LINE_QTY INT
	DECLARE	@PROD_SKU CHAR(8)

--INSERT CASE
		IF (EXISTS (SELECT * FROM INSERTED) AND
			NOT EXISTS (SELECT *FROM DELETED))
		BEGIN
			DECLARE INSERT_CURSOR CURSOR FOR
			SELECT	PROD_SKU, LINE_QTY
			FROM INSERTED
			GROUP BY LINE_QTY, PROD_SKU

				OPEN INSERT_CURSOR
				FETCH NEXT FROM INSERT_CURSOR INTO @LINE_QTY, @PROD_SKU
				WHILE (@@FETCH_STATUS = 0)
			BEGIN
				UPDATE LGPRODUCT
				SET PROD_QOH = PROD_QOH - @LINE_QTY
				WHERE PROD_SKU = @PROD_SKU
				FETCH NEXT FROM INSERT_CURSOR INTO @LINE_QTY, @PROD_SKU
			END
			CLOSE INSERT_CURSOR
			DEALLOCATE INSERT_CURSOR
		END
--DELETE CASE
		IF (EXISTS (SELECT * FROM DELETED) AND 
			NOT EXISTS (SELECT * FROM INSERTED))
		BEGIN
			DECLARE DELETE_CURSOR CURSOR FOR
			SELECT	PROD_SKU, LINE_QTY
			FROM DELETED
			GROUP BY PROD_SKU, LINE_QTY

			OPEN DELETE_CURSOR
			FETCH NEXT FROM DELETE_CURSOR INTO @LINE_QTY, @PROD_SKU
			WHILE (@@FETCH_STATUS = 0)
			BEGIN
				UPDATE LGPRODUCT
				SET PROD_QOH = PROD_QOH + @LINE_QTY
				WHERE PROD_SKU = @PROD_SKU
				FETCH NEXT FROM DELETE_CURSOR INTO @PROD_SKU, @LINE_QTY
			END
			CLOSE DELETE_CURSOR
			DEALLOCATE DELETE_CURSOR
		END
--UPDATE CASE
		IF (EXISTS (SELECT * FROM INSERTED) AND
			EXISTS (SELECT * FROM DELETED))
		BEGIN
			DECLARE UPDATE_CURSOR CURSOR FOR
			SELECT I.PROD_SKU, SUM(I.LINE_QTY - D.LINE_QTY) AS TOTAL
			FROM DELETED D INNER JOIN INSERTED I ON D.PROD_SKU = I.PROD_SKU
			GROUP BY I.PROD_SKU

			OPEN UPDATE_CURSOR
			FETCH NEXT FROM UPDATE_CURSOR INTO @PROD_SKU, @LINE_QTY
			WHILE (@@FETCH_STATUS = 0)
			BEGIN
				UPDATE LGPRODUCT
				SET PROD_QOH = PROD_QOH - @LINE_QTY
				WHERE PROD_SKU = @PROD_SKU
				FETCH NEXT FROM UPDATE_CURSOR INTO @PROD_SKU, @LINE_QTY
			END
			CLOSE UPDATE_CURSOR
			DEALLOCATE UPDATE_CURSOR
		END
END

--TEST CODE
SELECT	*
FROM	LGLINE
WHERE	PROD_SKU = '1504-LVK'

SELECT	*
FROM	LGLINE
WHERE	INV_NUM = 106

SELECT	*
FROM	LGPRODUCT
WHERE	PROD_SKU = '1504-LVK'
		
